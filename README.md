# 📚 Novel Auto Generator | 小说自动生成器

<div align="center">

![Version](https://img.shields.io/badge/version-1.1.0-blue.svg)
![SillyTavern](https://img.shields.io/badge/SillyTavern-1.10%2B-green.svg)
![License](https://img.shields.io/badge/license-MIT-orange.svg)

**🚀 一款 SillyTavern 扩展插件，让 AI 自动为你续写小说，解放双手！
支持断点续传、智能导出、标签提取、后处理插件兼容等功能**

[功能特性](#-功能特性) •
[快速开始](#-快速开始) •
[使用指南](#-使用指南) •
[高级功能](#-高级功能) •
[常见问题](#-常见问题)

</div>

---

## ✨ 功能特性

| 功能 | 描述 |
|:---:|:---|
| ⚡ **自动挂机生成** | 设定章节数，一键开始，自动发送提示词让 AI 持续创作 |
| 💾 **断点续传** | 随时暂停/恢复，进度自动保存，关闭页面也不丢失 |
| 🏷️ **智能标签提取** | 从 AI 回复中精准提取指定 XML 标签内容（如 `<content>`） |
| 📊 **实时统计** | 进度条、已用时间、预计剩余时间、错误统计一目了然 |
| 🔄 **自动重试** | 网络波动？响应超时？自动重试，稳定输出 |
| 📤 **多格式导出** | 支持 TXT / JSON 格式，灵活筛选楼层和消息类型 |
| 🔍 **插件兼容** | DOM 稳定性检查，完美兼容总结等后处理插件 |
| ❓ **内置帮助** | 每个设置面板都有详细帮助说明，新手友好 |

---

## 🚀 快速开始

### 安装步骤

1. **安装扩展**
   - 进入 `扩展` → `安装扩展`
   - 输入下面链接并安装：
   ```bash
   https://github.com/CyrilPeng/novel-auto-generator
   ```

2. **开始使用**
   - 启用扩展后，在侧边栏找到 📚 **小说自动生成器**
   - 设置目标章节数和提示词
   - 点击 ▶️ **开始**

---

## 📖 使用指南

### 🎯 基础用法：自动生成小说

```
1️⃣  打开一个角色对话（确保 AI 已有上下文）
     ↓
2️⃣  展开「📚 小说自动生成器」插件面板
     ↓
3️⃣  设置目标章节数（如 100 章）
     ↓
4️⃣  填写提示词（如 "继续"）
     ↓
5️⃣  点击 [▶️ 开始]
     ↓
6️⃣  挂机等待... 自动生成中 ☕
     ↓
7️⃣  完成后自动导出，或随时手动导出
```

### 💡 提示词参考

| 场景 | 提示词示例 |
|:---|:---|
| 简洁版 | 继续 |
| 标准版 | 继续推进剧情，保证流畅自然 |
| 详细版 | 请继续创作下一章，注意人物性格一致性，推进主线剧情 |
| 指定风格 | 继续，增加更多对话描写 |

### 🎛️ 控制按钮说明

| 按钮 | 功能 |
|:---:|:---|
| ▶️ 开始 | 从当前进度开始/继续生成 |
| ⏸️ 暂停 | 暂停生成（当前章节会完成后暂停） |
| ⏯️ 恢复 | 从暂停状态恢复生成 |
| ⏹️ 停止 | 完全停止生成任务 |
| 🔄 重置 | 将进度归零，从头开始 |

---

## 🎯 高级功能

### 🏷️ 标签提取

当你使用正则表达式美化 AI 输出时，原始回复可能包含多种标签。
使用**标签提取**功能，可以只导出指定标签内的正文。

```xml
<thinking>这是 AI 的思考过程...</thinking>

<content>
这里是小说正文内容，包含角色对话和情节描写...
</content>

<summary>本章总结...</summary>
```

#### 使用方法

1. ✅ **勾选「原始 (chat.mes)」** — 必须！读取未经正则处理的原始内容
2. 模式选择 **「只提取指定标签」**
3. 填写标签名：`content` 或 `content summary`（多标签用空格/逗号分隔）
4. 点击 **🔄 刷新预览** 确认提取效果
5. 导出时将只包含提取的内容！

#### 多标签提取规则

| 输入方式 | 效果 |
|:---|:---|
| `content` | 只提取 `<content>` 标签 |
| `content summary` | 同时提取两个标签 |
| `content, detail, 正文` | 逗号分隔也可以 |

> 💡 点击标签提取面板的 ❓ 按钮可查看详细帮助

---

### 🔍 DOM 稳定性检查（插件兼容）

**适用场景**：当你同时使用总结插件、记忆插件等后处理插件时。

**问题**：AI 生成完成后，其他插件可能还在修改消息内容（如添加总结），此时如果立即开始下一章，可能导致冲突。

**解决方案**：启用 DOM 稳定性检查，插件会监听消息 DOM 变化，只有在指定时间内没有任何变化才继续下一章。

#### 参数说明

| 参数 | 默认值 | 说明 |
|------|--------|------|
| DOM 安静时间 | 3000ms | DOM 需要保持多久不变化才算稳定 |
| 检测超时 | 120000ms | 最长等待时间，超时后强制继续 |
| 额外等待时间 | 1000ms | DOM 稳定后再额外等待的时间 |

#### 推荐配置

| 总结插件速度 | DOM 安静时间 | 检测超时 | 额外等待 |
|:------------:|:------------:|:--------:|:--------:|
| 快速 (10秒内) | 3000 | 60000 | 1000 |
| 中等 (30秒内) | 5000 | 120000 | 2000 |
| 较慢 (1分钟+) | 8000 | 180000 | 3000 |

> 💡 点击 DOM 稳定性检查区块的 ❓ 按钮可查看详细帮助

---

### 📤 楼层范围导出

默认导出所有楼层，也可以指定范围：

| 场景 | 设置 |
|------|------|
| 导出全部 | ✅ 勾选「导出全部」|
| 只导出 10-50 楼 | 取消勾选，设置起始=10，结束=50 |
| 只导出最后 100 楼 | 计算楼层号后设置 |

**导出选项**：
- 👤 **用户消息**：是否包含用户发送的内容
- 🤖 **AI 回复**：是否包含 AI 的回复
- 📄 **原始 (chat.mes)**：读取原始内容还是显示内容

> 💡 楼层从 **0** 开始计数，与 SillyTavern 一致

---

### ⚙️ 高级设置参数

#### 时间控制参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| 初始等待 | 2000ms | 发送消息前的等待时间，避免操作过快 |
| 完成等待 | 3000ms | AI 生成完成后的额外等待时间 |
| 稳定间隔 | 1000ms | 检测内容是否稳定的检查间隔 |
| 稳定次数 | 5 | 内容需要连续多少次检查不变才算稳定 |

#### 生成控制参数

| 参数 | 默认值 | 说明 |
|------|--------|------|
| 自动保存间隔 | 50 | 每生成多少章自动导出一次备份 |
| 最大重试 | 3 | 单章生成失败后的最大重试次数 |
| 最小章节长度 | 100 | AI 回复少于此字数视为失败，触发重试 |

#### 推荐配置方案

| 场景 | 初始等待 | 完成等待 | 稳定次数 |
|:----:|:--------:|:--------:|:--------:|
| 快速生成 | 1000 | 2000 | 3 |
| 标准（推荐） | 2000 | 3000 | 5 |
| 保守稳定 | 3000 | 5000 | 8 |

> 💡 点击高级设置面板的 ❓ 按钮可查看完整参数说明

---

## 🔧 调试

在浏览器控制台 (F12) 中可以使用调试命令：

```javascript
// 查看最后一条 AI 消息的原始内容
nagDebug()

// 查看指定楼层的原始内容（如第 5 楼）
nagDebug(5)
```

输出示例：
```
[NovelGen] ✅ chat 获取成功，共 50 条

----- 楼层 49 -----
mes: <content>这里是原始内容...</content>

----- 标签测试 [content] -----
结果: 这里是原始内容...
```

---

## ❓ 常见问题

<details>
<summary><b>Q: 标签提取不生效？</b></summary>

请检查：
1. ✅ 是否勾选了「原始 (chat.mes)」
2. 标签名是否正确（区分大小写）
3. 使用 `nagDebug()` 查看原始内容中是否包含该标签
4. 点击「🔄 刷新预览」查看提取效果

</details>

<details>
<summary><b>Q: 生成过程中频繁报错重试？</b></summary>

可能原因：
- 响应时间过长，超过默认超时
- AI 回复过短，未达到最小长度
- 网络波动

解决方案：
- 在「高级设置」中增加等待时间
- 降低最小章节长度要求
- 检查网络连接

</details>

<details>
<summary><b>Q: 使用总结插件时出现冲突？</b></summary>

启用 DOM 稳定性检查：
1. 展开「高级设置」面板
2. ✅ 勾选「启用 DOM 稳定性检查」
3. 根据你的总结插件速度调整「DOM 安静时间」
4. 如果总结插件很慢，可以增加「检测超时」时间

</details>

<details>
<summary><b>Q: 导出的内容是空的？</b></summary>

请检查：
1. 是否勾选了「🤖 AI 回复」
2. 楼层范围是否正确
3. 如果使用标签提取，确认标签名是否匹配
4. 使用预览功能确认内容存在

</details>

<details>
<summary><b>Q: 插件面板不显示？</b></summary>

1. 刷新页面
2. 检查浏览器控制台是否有错误
3. 确认扩展已启用
4. 尝试重新安装

</details>

<details>
<summary><b>Q: 如何查看帮助？</b></summary>

每个设置面板标题旁都有 ❓ 帮助按钮，点击即可查看该功能的详细说明。

</details>

---

## 📁 文件结构

```
novel-auto-generator/
├── manifest.json    # 扩展配置
├── index.js         # 主程序
├── style.css        # 样式表
└── README.md        # 说明文档
```

---

## 📊 工作流程图

```
                    ┌───────────────┐
                    │   点击开始    │
                    └───────┬───────┘
                            ▼
              ┌─────────────────────────┐
              │  检查是否已在运行/生成中 │
              └─────────────┬───────────┘
                            ▼
         ┌──────────────────────────────────┐
         │        循环: 当前章 < 目标章      │
         └──────────────────┬───────────────┘
                            ▼
                 ┌─────────────────┐
         ┌────── │   是否暂停？    │ ◄──┐
         │  是   └────────┬────────┘    │
         ▼                │ 否          │
    等待恢复信号  ─────────►│             │
                          ▼              │
              ┌─────────────────────┐    │
              │  发送提示词到 AI    │    │
              └─────────┬───────────┘    │
                        ▼                │
              ┌─────────────────────┐    │
              │  等待 AI 响应完成   │    │
              └─────────┬───────────┘    │
                        ▼                │
              ┌─────────────────────┐    │
              │  基础稳定性检查     │    │
              └─────────┬───────────┘    │
                        ▼                │
              ┌─────────────────────┐    │
              │  DOM 稳定性检查     │    │
              │  (等待后处理插件)   │    │
              └─────────┬───────────┘    │
                        ▼                │
              ┌─────────────────────┐    │
              │  检查响应是否有效   │    │
              └─────────┬───────────┘    │
                        ▼                │
                  ┌───────────┐          │
                  │  有效？   │          │
                  └─────┬─────┘          │
               是/      \否              │
              ▼          ▼               │
        保存进度    重试(最多3次)        │
        更新UI          │                │
              │         ▼                │
              │    还有重试机会？        │
              │    是→ 返回发送          │
              │    否→ 跳过本章          │
              │         │                │
              └────►────┴────────────────┘
                            ▼
              ┌─────────────────────────┐
              │     生成完成/被停止     │
              └─────────────┬───────────┘
                            ▼
              ┌─────────────────────────┐
              │      自动导出小说       │
              └─────────────────────────┘
```

---

## 📝 更新日志

### v1.1.0
- ✨ 新增 DOM 稳定性检查，兼容总结等后处理插件
- ✨ 新增内置帮助系统，每个面板都有详细说明
- 🐛 修复帮助弹窗显示位置问题
- 💄 优化 UI 布局和交互体验
- 🐛 修复了一些奇怪BUG

### v1.0.0
- 🎉 初始版本发布
- ⚡ 自动挂机生成功能
- 💾 断点续传支持
- 🏷️ 智能标签提取
- 📤 多格式导出

---

## 🤝 贡献

欢迎提交 Issue 和 Pull Request！

- 🐛 发现 Bug？请提 Issue
- 💡 有新想法？欢迎讨论
- 🔧 代码改进？请提 PR

---

## 📄 许可证

MIT License © 2024

---

<div align="center">

**Made with ❤️ for SillyTavern Community**

⭐ 如果这个插件对你有帮助，请给个 Star！

</div>