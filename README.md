# 📚 Novel Auto Generator | 小说自动生成器

<div align="center">

[![GitHub tag (latest by date)](https://img.shields.io/github/v/tag/CyrilPeng/Novel-Auto-Generator?sort=semver&label=version&color=blue)](https://github.com/CyrilPeng/Novel-Auto-Generator/tags)
[![SillyTavern](https://img.shields.io/badge/SillyTavern-1.10%2B-green.svg)](https://github.com/SillyTavern/SillyTavern)
[![License](https://img.shields.io/badge/license-MIT-orange.svg)](https://github.com/CyrilPeng/Novel-Auto-Generator/blob/main/LICENSE)

**🚀 一款 SillyTavern 扩展插件，让 AI 自动为你续写小说，解放双手！**

**支持断点续传、智能导出、标签提取、多插件兼容、TXT转世界书等功能**

[功能特性](#-功能特性) •
[快速开始](#-快速开始) •
[使用指南](#-使用指南) •
[TXT转世界书](#-txt转世界书) •
[高级功能](#-高级功能) •
[常见问题](#-常见问题)

</div>

---

## ✨ 功能特性

| 功能 | 描述 |
|:---:|:---|
| ⚡ **自动挂机生成** | 设定章节数，一键开始，自动发送提示词让 AI 持续创作 |
| 💾 **断点续传** | 随时暂停/恢复，进度自动保存，关闭页面也不丢失 |
| 🏷️ **智能标签提取** | 从 AI 回复中精准提取指定 XML 标签内容（如 `<content>`） |
| 📊 **实时统计** | 进度条、已用时间、预计剩余时间、错误统计一目了然 |
| 🔄 **自动重试** | 网络波动？响应过短？自动重试，稳定输出 |
| 📤 **多格式导出** | 支持 TXT / JSON 格式，灵活筛选楼层和消息类型 |
| 💬 **弹窗检测** | 智能检测插件弹窗，完美兼容剧情推进、总结等插件 |
| 📚 **TXT转世界书** | 将TXT小说转换为世界书格式，支持并行处理、重Roll、多种AI API |
| 📱 **移动端适配** | 完美支持手机端操作，随时随地挂机生成 |
| ❓ **内置帮助** | 每个设置面板都有详细帮助说明，新手友好 |

---

## 🚀 快速开始

### 安装步骤

1. **安装扩展**
   - 进入 `扩展` → `安装扩展`
   - 输入下面链接并安装：
   ```bash
   https://github.com/CyrilPeng/novel-auto-generator
   ```

2. **开始使用**
   - 启用扩展后，在扩展栏找到 📚 **小说自动生成器**
   - 设置目标章节数和提示词
   - 点击 ▶️ **开始**

---

## 📚 TXT转世界书（独立模块）

📖 **[查看详细使用指南 →](Worldinfo-User-Guide.md)**

### 什么是TXT转世界书？

**TXT转世界书**是一个智能工具，可以将TXT格式的小说文本自动转换为SillyTavern的**世界书（World Info）**格式。

**核心功能**：
- 🤖 **多API支持** - 酒馆API、Gemini、DeepSeek、OpenAI兼容等
- ⚡ **并行处理** - 多记忆块同时处理，效率提升
- 📝 **增量输出** - 节省Token，智能更新
- 🔀 **自动分裂** - Token超限自动处理
- 📜 **历史追踪** - 支持回退到任意版本
- 🎲 **重Roll功能** - 多次生成选择最佳结果
- 💾 **断点续传** - 刷新后可继续

### 快速开始（5分钟上手）

```
1️⃣  点击插件面板中的「📚 TXT转世界书」按钮
     ↓
2️⃣  选择API（推荐直接使用酒馆API，无需配置）
     ↓
3️⃣  上传TXT小说文件
     ↓
4️⃣  点击「🚀 开始转换」
     ↓
5️⃣  导出为SillyTavern格式，导入世界书
```

---

## 📖 使用指南

### 🎯 基础用法：自动生成小说

```
1️⃣  打开一个角色对话（确保 AI 已有上下文）
     ↓
2️⃣  展开「📚 小说自动生成器」插件面板
     ↓
3️⃣  设置目标章节数（如 100 章）
     ↓
4️⃣  填写提示词（如 "继续"）
     ↓
5️⃣  点击 [▶️ 开始]
     ↓
6️⃣  挂机等待... 自动生成中 ☕
     ↓
7️⃣  完成后自动导出，或随时手动导出
```

### 💡 提示词参考

| 场景 | 提示词示例 |
|:---|:---|
| 简洁版 | 继续 |
| 标准版 | 继续推进剧情，保证流畅自然 |
| 详细版 | 请继续创作下一章，注意人物性格一致性，推进主线剧情 |
| 指定风格 | 继续，增加更多对话描写 |

### 🎛️ 控制按钮说明

| 按钮 | 功能 |
|:---:|:---|
| ▶️ 开始 | 从当前进度开始/继续生成 |
| ⏸️ 暂停 | 暂停生成（当前章节会完成后暂停） |
| ⏯️ 恢复 | 从暂停状态恢复生成 |
| ⏹️ 停止 | 完全停止生成任务 |
| 🔄 重置 | 将进度归零，从头开始 |

---

## 🎯 高级设置

### 🏷️ 标签提取

当你使用正则表达式美化 AI 输出时，原始回复可能包含多种标签。
使用**标签提取**功能，可以只导出指定标签内的正文。

```xml
<thinking>这是 AI 的思考过程...</thinking>

<content>
这里是小说正文内容，包含角色对话和情节描写...
</content>

<summary>本章总结...</summary>
```

#### 使用方法

1. ✅ **勾选「原始 (chat.mes)」** — 必须！读取未经正则处理的原始内容
2. 模式选择 **「只提取指定标签」**
3. 填写标签名：`content` 或 `content summary`（多标签用空格/逗号分隔）
4. 点击 **🔄 刷新预览** 确认提取效果
5. 导出时将只包含提取的内容！

#### 多标签提取规则

| 输入方式 | 效果 |
|:---|:---|
| `content` | 只提取 `<content>` 标签 |
| `content summary` | 同时提取两个标签 |
| `content, detail, 正文` | 逗号分隔也可以 |

> 💡 点击标签提取面板的 ❓ 按钮可查看详细帮助

---

### 💬 弹窗检测（插件兼容）

**适用场景**：当你同时使用剧情推进插件、总结插件、记忆插件等时。

**工作原理**：检测页面上的弹窗通知，等待弹窗消失后再继续，确保其他插件处理完成。

#### 两阶段弹窗检测

| 阶段 | 说明 | 典型场景 |
|:----:|:-----|:---------|
| 📤 **发送阶段** | 消息发送后检测 | 剧情推进插件处理消息 |
| 📥 **回复阶段** | AI回复后检测 | 总结插件处理回复内容 |

#### 参数说明

| 参数 | 默认值 | 说明 |
|------|--------|------|
| 等待超时 | 发送60秒/回复5分钟 | 最长等待弹窗消失的时间 |
| 额外等待 | 1-2秒 | 弹窗消失后再额外等待的时间 |

---

### 📤 楼层范围导出

默认导出所有楼层，也可以指定范围：

| 场景 | 设置 |
|------|------|
| 导出全部 | ✅ 勾选「导出全部」|
| 只导出 10-50 楼 | 取消勾选，设置起始=10，结束=50 |
| 只导出最后 100 楼 | 计算楼层号后设置 |

**导出选项**：
- 👤 **用户消息**：是否包含用户发送的内容
- 🤖 **AI 回复**：是否包含 AI 的回复
- 📄 **原始 (chat.mes)**：读取原始内容还是显示内容

> 💡 楼层从 **0** 开始计数，与 SillyTavern 一致

---

### ⚙️ 高级设置

高级设置分为三个模块，清晰明了：

#### 📤 发送阶段
| 参数 | 默认值 | 说明 |
|------|--------|------|
| 弹窗检测 | ✅ 开启 | 检测剧情推进等插件的弹窗 |
| 等待超时 | 60秒 | 最长等待弹窗消失时间 |
| 额外等待 | 1秒 | 弹窗消失后额外等待 |

#### 📥 回复阶段
| 参数 | 默认值 | 说明 |
|------|--------|------|
| 回复后等待 | 5秒 | AI回复稳定后等待，让总结插件启动 |
| 稳定检查间隔 | 1秒 | 检查内容是否稳定的间隔 |
| 稳定次数 | 3次 | 连续多少次不变才算稳定 |
| 弹窗检测 | ✅ 开启 | 检测总结等插件的弹窗 |
| 等待超时 | 5分钟 | 最长等待弹窗消失时间 |
| 额外等待 | 2秒 | 弹窗消失后额外等待 |

#### 🔧 生成控制
| 参数 | 默认值 | 说明 |
|------|--------|------|
| 自动保存间隔 | 50章 | 每生成多少章自动导出备份 |
| 最大重试 | 3次 | 单章失败后的最大重试次数 |
| 最小章节长度 | 100字 | 低于此字数视为失败 |

> 💡 点击高级设置面板的 ❓ 按钮可查看完整参数说明

---

## 📊 工作流程图

```
发送消息
    ↓
[发送阶段弹窗检测] ← 等待剧情推进插件
    ↓
等待AI消息数量增加
    ↓
等待内容稳定 (长度不再变化)
    ↓
固定等待时间
    ↓
[回复阶段弹窗检测] ← 等待总结插件
    ↓
再次稳定性检查
    ↓
检查章节长度 → 通过 → 保存进度 → 下一章
                 ↓
              失败 → 重试 (最多3次)
```

---

## 🔧 调试

在浏览器控制台 (F12) 中可以使用调试命令：

```javascript
// 查看最后一条 AI 消息的原始内容
nagDebug()

// 查看指定楼层的原始内容（如第 5 楼）
nagDebug(5)
```

输出示例：
```
[NovelGen] ✅ chat 获取成功，共 50 条

----- 楼层 49 -----
mes: <content>这里是原始内容...</content>

----- 标签测试 [content] -----
结果: 这里是原始内容...
```

---

## ❓ 常见问题

<details>
<summary><b>Q: 标签提取不生效？</b></summary>

请检查：
1. ✅ 是否勾选了「原始 (chat.mes)」
2. 标签名是否正确（区分大小写）
3. 使用 `nagDebug()` 查看原始内容中是否包含该标签
4. 点击「🔄 刷新预览」查看提取效果

</details>

<details>
<summary><b>Q: 生成过程中频繁报错重试？</b></summary>

可能原因：
- AI 回复过短，未达到最小长度
- 网络波动

解决方案：
- 降低「最小章节长度」要求
- 检查网络连接
- 增加「回复后等待」时间

</details>

<details>
<summary><b>Q: 使用剧情推进/总结插件时出现冲突？</b></summary>

解决方案：
1. 展开「高级设置」面板
2. 在对应阶段 ✅ 勾选「启用弹窗检测」
3. 如果插件处理很慢，可以增加「等待超时」时间
4. 增加「额外等待」时间确保处理完成

</details>

<details>
<summary><b>Q: 导出的内容是空的？</b></summary>

请检查：
1. 是否勾选了「🤖 AI 回复」
2. 楼层范围是否正确
3. 如果使用标签提取，确认标签名是否匹配
4. 使用预览功能确认内容存在

</details>

<details>
<summary><b>Q: 插件面板不显示？</b></summary>

1. 刷新页面
2. 检查浏览器控制台是否有错误
3. 确认扩展已启用
4. 尝试重新安装

</details>

<details>
<summary><b>Q: TXT转世界书API报错404？</b></summary>

请检查：
1. API Endpoint是否正确（如 `http://127.0.0.1:5000/v1`）
2. 使用「⚡ 快速测试」验证API连接
3. 确认模型名称正确
4. 如果使用本地模型，确保服务已启动
5. 或者改用「使用酒馆API」选项，无需额外配置

</details>

<details>
<summary><b>Q: TXT转世界书处理很慢？</b></summary>

优化建议：
1. 开启**并行处理**，设置并发数为2-3
2. 选择更快的模型（如 gemini-3-flash）
3. 减小每块字数，让单个记忆块处理更快
4. 可以随时暂停，进度会自动保存

</details>

<details>
<summary><b>Q: 世界书生成的内容不准确？</b></summary>

建议：
1. 使用更强的AI模型（如 gemini-3-pro）
2. 减小「每块字数」设置，让AI更专注
3. 使用「🔧 修复失败」重新处理失败的记忆块
4. 使用「🎲 重Roll」功能对不满意的结果重新生成
5. 使用「🔗 别名合并」合并同一角色的不同称呼

</details>

---

## 📁 文件结构

```
novel-auto-generator/
├── manifest.json        # 扩展配置
├── index.js             # 主程序
├── txtToWorldinfo.js    # TXT转世界书模块
├── style.css            # 样式表
└── README.md            # 说明文档
```

---

## 📝 更新日志

### v1.4.0
- ✨ **TXT转世界书大幅升级**
- 🤖 新增「使用酒馆API」选项，无需额外配置即可使用当前连接的AI
- ⚡ 支持并行处理，多个记忆块同时处理（并发数1-5可调）
- 🎲 新增重Roll功能，每个记忆块可多次生成选择最佳结果
- 📝 新增记忆编辑功能，可查看/编辑/复制原文内容
- ⬆️⬇️ 新增章节合并功能，可将当前章节合并到上/下一章
- 🗑️ 新增多选删除功能，批量选择并删除记忆块
- 📍 新增起始位置选择，可从任意章节开始处理
- 🔍 新增查找高亮和批量替换功能
- 🔗 新增别名合并功能，AI识别同一角色不同称呼并合并
- ⚙️ 新增条目配置功能，每个条目可单独配置位置/深度/顺序
- 🔵🟢 新增分类灯状态设置（常驻/触发）
- 📚 新增自定义分类功能，可添加/编辑/删除世界书分类
- 📥 新增合并世界书功能，导入已有世界书进行AI智能合并
- 💾 新增任务导入/导出功能，保存和恢复处理进度
- ⚙️ 新增设置导入/导出功能，保存和恢复工具配置

### v1.3.0
- ✨ **新增 TXT转世界书功能**，将TXT小说转换为SillyTavern世界书格式
- ✨ 支持多种AI API（Gemini、DeepSeek、Gemini代理、OpenAI兼容）
- ✨ 增量输出模式，智能更新世界书条目
- ✨ 记忆分裂机制，自动处理Token超限
- ✨ 完整的历史追踪与回滚功能
- ✨ AI优化世界书功能
- ✨ OpenAI兼容模式支持拉取模型列表和快速测试
- 🐛 修复弹窗背景过暗的问题
- 🐛 修复关闭弹窗导致插件栏折叠的问题
- 🐛 修复暂停功能不生效的问题
- 💄 优化弹窗UI，背景透明度调整为50%

### v1.2.0
- ✨ 全新高级设置 UI，三大模块清晰分隔（发送/回复/生成控制）
- ✨ 新增双阶段弹窗检测，分别兼容发送和回复阶段的插件
- 📱 完美适配移动端，帮助弹窗居中显示
- 🐛 修复移动端关闭弹窗导致插件栏折叠的问题
- 🐛 修复帮助弹窗背景透明的问题
- 💄 优化模块化 UI 设计，不同模块使用不同强调色
- 🔧 简化检测逻辑，提高稳定性

### v1.1.0
- ✨ 新增 DOM 稳定性检查，兼容总结等后处理插件
- ✨ 新增内置帮助系统，每个面板都有详细说明
- 🐛 修复帮助弹窗显示位置问题
- 💄 优化 UI 布局和交互体验

### v1.0.0
- 🎉 初始版本发布
- ⚡ 自动挂机生成功能
- 💾 断点续传支持
- 🏷️ 智能标签提取
- 📤 多格式导出

---

## 🤝 贡献

欢迎提交 Issue 和 Pull Request！

- 🐛 发现 Bug？请提 Issue
- 💡 有新想法？欢迎讨论
- 🔧 代码改进？请提 PR

---

## 📄 许可证

MIT License © 2024

---

<div align="center">

**Made with ❤️ for SillyTavern Community**

⭐ 如果这个插件对你有帮助，请给个 Star！

</div>